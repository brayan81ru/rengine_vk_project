#include "PBRCommon.fxh"

Texture2D    g_AlbedoMap;
Texture2D    g_NormalMap;
Texture2D    g_MetallicRoughnessMap;

float4 main(PSInput PSIn) : SV_TARGET
{
    // Sample PBR textures
    float3 albedo = g_AlbedoMap.Sample(g_LinearSampler, PSIn.UV).rgb;
    float metallic = g_MetallicRoughnessMap.Sample(g_LinearSampler, PSIn.UV).b * g_Material.Metallic;
    float roughness = g_MetallicRoughnessMap.Sample(g_LinearSampler, PSIn.UV).g * g_Material.Roughness;

    // Normal mapping
    float3 normal = CalculateNormalMap(PSIn.Normal, PSIn.Tangent, g_NormalMap, PSIn.UV);

    // PBR lighting
    float3 Lo = CalculatePBRLighting(albedo, normal, metallic, roughness, PSIn.WorldPos);

    // Add skybox ambient
    float3 ambient = g_Skybox.Sample(g_LinearSampler, normal).rgb * 0.03;
    float3 color = ambient + Lo;

    return float4(color, 1.0);
}